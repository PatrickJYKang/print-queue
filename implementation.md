# Implementation Plan (Internal)

The following has been generated by AI for its own use. This is not a final product. This has not been fully checked and approved. 

This document outlines the folder structure and step-by-step plan to implement the Discord-based, user-reported 3D printer queue. It reflects the constraints in technical.md: macOS runtime, no hardware polling/MQTT, access-hours deferral, mandatory close-before-start, and the new notdone flow.

## Folder Structure

```text
print-queue/
├─ README.md
├─ action_plan.md
├─ technical.md
├─ implementation.md                # This document
├─ .env.example                     # Example env file (token, channel IDs, access hours)
├─ data/                            # Runtime data (gitignored)
│  └─ queue.db                      # SQLite database (created at first run)
├─ logs/                            # Runtime logs (gitignored)
│  └─ app.log
└─ src/
   ├─ app.py                        # Entry point: wires bot, queue manager, scheduler
   ├─ config/
   │  ├─ __init__.py
   │  ├─ settings.py                # Loads env, access hours, defaults (claim/start)
   │  └─ printers.yaml              # Printer labels/IDs only (no IPs)
   ├─ db/
   │  ├─ __init__.py
   │  ├─ schema.sql                 # DDL for jobs, printers, events
   │  └─ sqlite.py                  # Helper: connect, migrate, tx helpers
   ├─ core/
   │  ├─ queue_manager.py           # Queue ops, invariants, idempotency, access hours
   │  ├─ scheduler.py               # Predicted-availability timers, claim/start timeouts
   │  ├─ access_hours.py            # Time-window calculations, deferrals
   │  ├─ timeparse.py               # Parse durations: 90m, 1h30m, 2:15, etc.
   │  └─ events.py                  # Event model + append helpers
   ├─ bot/
   │  ├─ __init__.py
   │  ├─ discord_bot.py             # Bot lifecycle, router for slash commands
   │  └─ commands.py                # Handlers for /join /claim /close /notdone /report started /...
   └─ utils/
      ├─ logging_setup.py           # Rotating logs config
      └─ formatting.py              # Human-readable times, positions, mentions
```

Notes:
- data/ and logs/ should be in .gitignore.
- We will not create extra files until needed; the structure is a target state.

## Implementation Checklist

- [ ] Bootstrap & Dependencies
  - [ ] Create venv
  - [ ] Install deps: discord.py, aiosqlite/sqlite3, python-dotenv, APScheduler (opt), pytz/zoneinfo (if needed)
  - [ ] Add `.env.example` with DISCORD_TOKEN, GUILD_ID (opt), CHANNEL_IDs, TZ, ACCESS_HOURS, DEFAULT_CLAIM_MIN, DEFAULT_START_MIN

- [ ] Schema & Persistence
  - [ ] Write db/schema.sql (jobs, printers, events)
  - [ ] Implement db/sqlite.py (init/migrate, helpers, Tx)

- [ ] Time Utilities
  - [ ] Implement core/timeparse.py (90m, 1h30m, 2:15, 150 -> minutes)
  - [ ] Implement utils/formatting.py (durations, timestamps)

- [ ] Access Hours Rules
  - [ ] Implement core/access_hours.py (in_hours, next_opening_after)
  - [ ] Integrate deferral logic in queue manager & scheduler

- [ ] Queue Manager (core/queue_manager.py)
  - [ ] Public APIs: join_queue, update_time, status, myjobs
  - [ ] Predictions: compute_printer_predictions -> printers.predicted_available_at
  - [ ] Scheduling hook: schedule_next_notifications
  - [ ] Claim flow: claim(printer_id, user) sets reserved and deadlines
  - [ ] Not-done flow: notdone(...) validates claimer, adjusts predictions, releases claim, emits claim_release, reschedules
  - [ ] Close flow: close(...) validates and records outcome; photo required on fail
  - [ ] Start flow: report_started(...) blocked until closed; sets started_at
  - [ ] Cancel flow: cancel(job_id, user)
  - [ ] Invariants enforced (one current_job_id per printer; access-hours respected)

- [ ] Scheduler (core/scheduler.py)
  - [ ] Use APScheduler or asyncio timers
  - [ ] Jobs: predicted free -> notify; claim timeout; start timeout
  - [ ] /notdone: cancel/reschedule, apply access-hours, log claim_release
  - [ ] Idempotent handlers (state re-check before act)

- [ ] Discord Bot (bot/discord_bot.py, bot/commands.py)
  - [ ] Register slash commands (guild-scoped for dev)
  - [ ] Implement command handlers and validation
  - [ ] Notifications to channel/DM, append to events

- [ ] App Wiring (src/app.py)
  - [ ] Load settings, init DB, seed printers
  - [ ] Init QueueManager, recompute predictions
  - [ ] Start Scheduler
  - [ ] Register and run bot
  - [ ] Logging and graceful shutdown

- [ ] Access-Hours & Timeouts Tests
  - [ ] Unit tests for access-hours deferral
  - [ ] Tests for claim/start timeout logic
  - [ ] Tests for /notdone releasing claims and rescheduling
  - [ ] Tests for close-before-start enforcement
  - [ ] Idempotency of timers

- [ ] macOS Run & Service
  - [ ] Dev run with `caffeinate -dimsu python -m src.app`
  - [ ] Add launchd plist example and log rotation guidance

## Rollout Phases

- Phase 1: Minimal queue with /join, /status, DB init.
- Phase 2: Predictions + scheduler + claim notification.
- Phase 3: /claim + claim timeout; access-hours deferral.
- Phase 4: /close + /report started (block until close); start timeout.
- Phase 5: /notdone + rescheduling + claim release.
- Phase 6: /update_time, /cancel, /myjobs, event logging polish, basic analytics.
- Phase 7: Hardening (idempotency, race guards), admin tools, README for ops.

## Non-Functional
- Concurrency: single event loop; atomic DB updates; row-level checks for state transitions.
- Observability: structured logging; events table as audit trail.
- Safety: validation for command permissions (claimer-only actions), input parsing, and rate limits.
- Configurability: timeouts and access hours via env; printers via YAML labels.
