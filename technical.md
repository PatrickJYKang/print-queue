 # 3D Printer Queue + Discord Bot System — Planning Document


The following has been generated by AI and fully checked and approved by me.

 ## User-Side Workflow

 **Text Description**

 - **Goal** Fair, automated queue for 3× Bambu Lab X1C printers via Discord not using manual monitor
 - **Join the queue** User runs `/join job_name est_time`. Bot replies with queue position and estimated wait based on active jobs and estimates.
 - **Automatic notifications** When any printer becomes IDLE, the bot pings the next user to claim within 10 minutes.
 - **Claim window** `/claim` within 10 minutes reserves a specific printer and starts a 15-minute print-start window. If not claimed, the bot expires the hold and pings the next user.
 - **Start window** Printer must report PRINTING within 15 minutes. If not, the reservation is released and the next user is notified.
 - **Completion logging** On FINISHED or FAILED, the job is logged with actual duration and outcome. The next user is notified automatically.
 - **Queue commands** `/cancel`, `/update_time`, `/status`, `/myjobs`, `/predict` (optional later: `/history`).
 - **Fairness & persistence** Single shared FIFO queue across all printers. Timeouts enforce fairness. Queue state persists across restarts.

 ```mermaid
 flowchart TD
   U[User] --> JOIN[Run /join with job_name and est_time]
   JOIN --> AJ[Queue Manager: Add job]
   AJ --> RP[Bot: Reply with position and ETA]

   W[Printer Watcher: any printer becomes IDLE] --> N[Bot: Notify next user to claim within 10 min]
   N --> D{Claimed within 10 min?}
   D -->|Yes| R[Reserve specific printer]
   D -->|No| NX[Expire claim and notify next user]

   R --> S1[Start window: 15 min]
   S1 --> E{Printer reports PRINTING?}
   E -->|Yes| CS[Bot: Confirm start and post ETA]
   E -->|No| RL[Release reservation and notify next user]

   CS --> MON[Monitor until FINISHED or FAILED]
   MON --> F{Outcome}
   F -->|FINISHED| LOG[Log completion and actual time]
   F -->|FAILED| LOGF[Log failure and actual time]

   LOG --> NEXT[Ping next user]
   LOGF --> NEXT

   U --> CANCEL[Run /cancel]
   CANCEL --> CANC[Remove job and update queue]
   U --> UPDATE[Run /update_time]
   UPDATE --> UPD[Adjust estimate and recompute ETAs]
   U --> STATUS[Run /status or /myjobs]
   STATUS --> ST[Show queue and printer states]
   U --> PRED[Run /predict]
   PRED --> PR[Suggest duration heuristic]
 ```

 ## Backend Tech Stack and Layers

 **Text**

 - **Runtime & Platform** Raspberry Pi OS Lite, Python 3.10+, systemd service, venv.
 - **Key Libraries** `discord.py` (or `nextcord`), `aiohttp`, `paho-mqtt` (if using MQTT), `sqlite3` (built-in) or `aiosqlite`, `python-dotenv`.
 - **Configuration** `.env` for Discord token and settings. `printers.yaml` for printer hosts/IDs. Timeouts: claim=10 min, start=15 min.
 - **Data Model (SQLite)**  
   - **jobs**: id, user_id, username, job_name, est_minutes, status[queued|reserved|printing|completed|failed|canceled], printer_id, created_at, claim_deadline_at, start_deadline_at, started_at, finished_at, actual_minutes, notes/outcome.
   - **printers**: id, name, host/ip, last_state, last_seen_at, current_job_id.
   - **events**: ts, printer_id, job_id, type[state_change|notify|timeout|command], payload(json).
 - **Printer Watcher Module** Poll Bambu API or subscribe to MQTT. Track transitions IDLE/PRINTING/PAUSED/FINISHED/FAILED, debounce noise, backoff on errors, emit state-change events.
 - **Queue Manager Module** FIFO across all printers, persistence in SQLite, idempotent operations, recompute ETAs on changes, enforce claim/start timeouts, crash-safe recovery on restart, concurrency-safe reservations.
 - **Discord Bot Module** Slash commands `/join /claim /cancel /status /update_time /myjobs /predict`. Post notifications to a channel and mention users. Guard rails (rate limits, permission checks for admins).
 - **Scheduler/Main Loop** Async tasks: printer watchers, timeout scanner, notifier. Event bus (in-process) to coordinate modules.
 - **Logging & Analytics** Append to `events`, compute aggregates for prediction (median/EMA by material/profile/printer), optional `/history` later.
 - **Deployment** Single process on the Pi. Systemd unit to auto-start, rotate logs, and restart on failure.
 
 ```mermaid
 flowchart LR
   USR[Discord Users] --> BOT[Discord Bot Module]
   BOT <--> QM["Queue Manager\n(ETAs, Timeouts, Persistence)"]
   QM <--> DB[(SQLite)]

   subgraph Printing
     PW[Printer Watcher]
     IO[(Bambu API or MQTT)]
   end

   IO <--> PW
   PW --> QM
   QM --> BOT

   subgraph Core Services
     SCH[Timeout Scanner and Scheduler]
     EVT[Event Log and Analytics]
   end

   SCH --> QM
   QM --> EVT
   BOT --> EVT
 ```
